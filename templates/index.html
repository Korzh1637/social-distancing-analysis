<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–Ω–∞–ª–∏–∑ —Å–æ—Ü–∏–∞–ª—å–Ω–æ–π –¥–∏—Å—Ç–∞–Ω—Ü–∏–∏</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .dashboard {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        .video-container {
            background: white;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .metrics-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .btn-start {
            background: #28a745;
            color: white;
        }
        .btn-stop {
            background: #dc3545;
            color: white;
        }
        .btn-settings {
            background: #007bff;
            color: white;
        }
        .metric-card {
            background: #f8f9fa;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            border-left: 4px solid #007bff;
        }
        .violation-alert {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
        }
        .critical-violation {
            background: #f8d7da;
            border-left: 4px solid #dc3545;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>AI –ê–Ω–∞–ª–∏–∑ —Å–æ—Ü–∏–∞–ª—å–Ω–æ–π –¥–∏—Å—Ç–∞–Ω—Ü–∏–∏</h1>
            <p>–°–∏—Å—Ç–µ–º–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —Å–æ–±–ª—é–¥–µ–Ω–∏—è —Å–æ—Ü–∏–∞–ª—å–Ω–æ–π –¥–∏—Å—Ç–∞–Ω—Ü–∏–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏</p>
        </div>

        <div class="controls">
            <select id="videoSource">
                <option value="test">–¢–µ—Å—Ç–æ–≤–æ–µ –≤–∏–¥–µ–æ</option>
                <option value="camera">–í–µ–±-–∫–∞–º–µ—Ä–∞</option>
            </select>
            <button class="btn-start" onclick="startProcessing()">‚ñ∂Ô∏è –ó–∞–ø—É—Å–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏</button>
            <button class="btn-stop" onclick="stopProcessing()">‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∫–∞</button>
            <button class="btn-settings" onclick="updateSettings()">‚öôÔ∏è –û–±–Ω–æ–≤–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
        </div>

        <div class="dashboard">
            <div class="video-container">
                <h3>üé• –í–∏–¥–µ–æ–ø–æ—Ç–æ–∫</h3>
                <img id="videoFeed" src="{{ url_for('video_feed') }}" width="100%">
            </div>

            <div class="metrics-container">
                <h3>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
                <div id="metrics">
                    <div class="metric-card">
                        <strong>–õ—é–¥–µ–π –≤ –∫–∞–¥—Ä–µ:</strong> <span id="peopleCount">0</span>
                    </div>
                    <div class="metric-card">
                        <strong>–ù–∞—Ä—É—à–µ–Ω–∏—è:</strong> <span id="violationsCount">0</span>
                    </div>
                    <div class="metric-card">
                        <strong>–ü–ª–æ—Ç–Ω–æ—Å—Ç—å:</strong> <span id="density">0.0</span> —á–µ–ª/–º¬≤
                    </div>
                    <div class="metric-card">
                        <strong>–£—Ä–æ–≤–µ–Ω—å —Ä–∏—Å–∫–∞:</strong> <span id="riskLevel">–ù–∏–∑–∫–∏–π</span>
                    </div>
                </div>

                <h4>–ê–∫—Ç–∏–≤–Ω—ã–µ –Ω–∞—Ä—É—à–µ–Ω–∏—è</h4>
                <div id="violationsList"></div>

                <h4>–õ–æ–≥ —Å–æ–±—ã—Ç–∏–π</h4>
                <div id="eventsLog"></div>
            </div>
        </div>
    </div>

    <script>
        let updateInterval;

        function startProcessing() {
            const videoSource = document.getElementById('videoSource').value;
            
            fetch('/api/start_processing', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({video_source: videoSource})
            })
            .then(response => response.json())
            .then(data => {
                console.log('–û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—É—â–µ–Ω–∞:', data);
                startUpdatingMetrics();
            });
        }

        function stopProcessing() {
            fetch('/api/stop_processing', {method: 'POST'})
            .then(response => response.json())
            .then(data => {
                console.log('–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞:', data);
                stopUpdatingMetrics();
            });
        }

        function updateSettings() {
            const confidence = 0.5;
            fetch('/api/update_settings', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({confidence: confidence})
            });
        }

        function startUpdatingMetrics() {
            updateInterval = setInterval(updateMetrics, 1000);
        }

        function stopUpdatingMetrics() {
            if (updateInterval) {
                clearInterval(updateInterval);
            }
        }

        function updateMetrics() {
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫
            fetch('/api/metrics')
                .then(response => response.json())
                .then(metrics => {
                    document.getElementById('peopleCount').textContent = metrics.people_count || 0;
                    document.getElementById('violationsCount').textContent = metrics.violations_count || 0;
                    document.getElementById('density').textContent = metrics.density ? metrics.density.toFixed(1) : '0.0';
                    document.getElementById('riskLevel').textContent = metrics.risk_level || '–ù–∏–∑–∫–∏–π';
                });

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–∞—Ä—É—à–µ–Ω–∏–π
            fetch('/api/violations')
                .then(response => response.json())
                .then(violations => {
                    const violationsList = document.getElementById('violationsList');
                    violationsList.innerHTML = '';
                    
                    violations.forEach(violation => {
                        const div = document.createElement('div');
                        div.className = violation.severity === 'critical' ? 
                            'violation-alert critical-violation' : 'violation-alert';
                        div.innerHTML = `
                            <strong>–õ—é–¥–∏ ${violation.person1} –∏ ${violation.person2}</strong><br>
                            –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ: ${violation.distance.toFixed(2)}–º
                        `;
                        violationsList.appendChild(div);
                    });
                });

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π
            fetch('/api/events')
                .then(response => response.json())
                .then(events => {
                    const eventsLog = document.getElementById('eventsLog');
                    eventsLog.innerHTML = '';
                    
                    events.slice(-5).forEach(event => {
                        const div = document.createElement('div');
                        div.className = 'violation-alert';
                        div.innerHTML = `
                            <small>${event.timestamp}</small><br>
                            ${event.message}
                        `;
                        eventsLog.appendChild(div);
                    });
                });
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –º–µ—Ç—Ä–∏–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        startUpdatingMetrics();
    </script>
</body>
</html>